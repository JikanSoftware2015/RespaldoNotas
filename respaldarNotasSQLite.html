<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Respaldar Notas a blocdenotas_backup.db</title>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f5f5f5; }
    input, textarea { width: 100%; padding: 8px; margin: 5px 0 15px; font-size: 15px; }
    button { margin: 10px 0; padding: 10px 20px; font-size: 16px; }
    .nota { border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; background: #fff; border-radius: 8px; }
  </style>
</head>
<body>

<h2>Generar respaldo blocdenotas_backup.db</h2>
<p>Completa tus notas aquí. Puedes agregar hasta 500 notas.</p>

<div id="contenedorNotas"></div>

<button onclick="agregarNota()">+ Agregar otra nota</button>
<br>
<button onclick="generarRespaldo()">Descargar respaldo_blocdenotas.db</button>

<script src="https://sql.js.org/dist/sql-wasm.js"></script>
<script>
let contadorNotas = 0;
const LIMITE_NOTAS = 500;

function agregarNota() {
  if (contadorNotas >= LIMITE_NOTAS) {
    alert("Has alcanzado el límite de 500 notas.");
    return;
  }

  contadorNotas++;
  const div = document.createElement('div');
  div.className = 'nota';
  div.innerHTML = `
    <h3>Nota ${contadorNotas}</h3>
    <input type="text" placeholder="Título de la nota" id="titulo${contadorNotas}">
    <textarea placeholder="Contenido de la nota" rows="4" id="contenido${contadorNotas}"></textarea>
  `;
  document.getElementById('contenedorNotas').appendChild(div);
}

async function generarRespaldo() {
  const SQL = await initSqlJs({ locateFile: file => `https://sql.js.org/dist/${file}` });
  const db = new SQL.Database();
  db.run("CREATE TABLE notes (title TEXT, body TEXT, updated_at INTEGER);");

  const now = Date.now();
  let notasInsertadas = 0;

  for (let i = 1; i <= contadorNotas; i++) {
    const tituloInput = document.getElementById(`titulo${i}`);
    const contenidoInput = document.getElementById(`contenido${i}`);

    if (!contenidoInput) continue;

    const titulo = tituloInput?.value.trim() || "Sin título";
    const contenido = contenidoInput.value.trim();

    if (contenido) {
      db.run("INSERT INTO notes (title, body, updated_at) VALUES (?, ?, ?);", [titulo, contenido, now + i]);
      notasInsertadas++;
    }
  }

  if (notasInsertadas === 0) {
    alert("Debes ingresar al menos una nota con contenido.");
    return;
  }

  const binaryArray = db.export();
  const blob = new Blob([binaryArray], { type: 'application/octet-stream' });
  const enlace = document.createElement('a');
  enlace.href = URL.createObjectURL(blob);
  enlace.download = 'respaldo_blocdenotas.db';
  enlace.click();
}

agregarNota();
</script>

</body>
</html>
